{% extends 'core/base.html' %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'home' %}">Home</a> /
    <a href="{% url 'issue_list' %}">Edições</a> /
    {{ issue }}
</div>

<div class="header-actions">
    <h1>{{ issue }}</h1>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
        <a href="{% url 'issue_cover_create' issue.pk %}" title="Upload Cover from Computer" class="open-modal"
            style="color: inherit;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        </a>
        <a href="{% url 'issue_cover_url_add' issue.pk %}" title="Import Cover from URL" class="open-modal"
            style="color: inherit;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        </a>
        <a href="{% url 'issue_delete' issue.pk %}" class="btn-trash open-modal" title="Delete Issue">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        </a>
    </div>
</div>

<style>
    .cover-card {
        width: 200px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        cursor: default;
        position: relative;
    }

    /* State for double covers (foldout) */
    .cover-card.double-cover {
        cursor: pointer;
    }

    /* Folded state: Default for double covers */
    .cover-card.double-cover.folded {
        width: 200px;
    }

    .cover-card.double-cover.folded img {
        width: 200%;
        max-width: none !important;
        /* Show the left half (Primary) as requested */
        transform: translateX(0);
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    /* Unfolded state */
    .cover-card.double-cover.unfolded {
        /* Width will be set by JS usually to maintain height consistency */
    }

    .cover-card.double-cover.unfolded img {
        width: 100%;
        transform: translateX(0);
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    /* Ensure image is block */
    .cover-card img {
        display: block;
        width: 100%;
        height: auto;
    }
</style>

{% if issue.covers.exists %}
<div class="covers-gallery" style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem;">
    {% for cover in issue.covers.all %}
    <div class="cover-card">
        <img src="{{ cover.image.url }}" alt="Cover">
    </div>
    {% endfor %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const coverCards = document.querySelectorAll('.cover-card');

        coverCards.forEach(card => {
            const img = card.querySelector('img');

            function handleImageLoad() {
                // Check if it's a double cover (Landscape orientation)
                // Using a threshold of 1.2 aspect ratio to be safe
                const aspect = img.naturalWidth / img.naturalHeight;

                if (aspect > 1.2) {
                    card.classList.add('double-cover', 'folded');

                    // Add click to toggle
                    card.addEventListener('click', function () {
                        const isFolded = card.classList.contains('folded');

                        if (isFolded) {
                            // Unfold
                            // Calculate target width based on height to keep height constant
                            // Folded state height:
                            // We force width=200px. 
                            // Folded Logic: Image width 200% -> 400px.
                            // Height = 400 / aspect.
                            const height = 400 / aspect; // This is the displayed height

                            // Unfolded Logic:
                            // We want width s.t. height is same?
                            // Height = Width / aspect.
                            // If we want Height to be same, then Width must be 400px.
                            // So simply setting width to 400px should work if 200% was correct estimate.

                            // More generic:
                            // Folded Img Width = 2 * 200px = 400px.
                            // If we want unfolded view to show full image at same scale, width should be 400px.
                            // But maybe we want it distinct?
                            // Let's just set width to what the image "would be" if width=100% at that height.
                            // Yes, 400px.

                            card.style.width = '400px';
                            card.classList.remove('folded');
                            card.classList.add('unfolded');
                        } else {
                            // Fold
                            card.style.width = '200px';
                            card.classList.remove('unfolded');
                            card.classList.add('folded');
                        }
                    });
                }
            }

            if (img.complete) {
                handleImageLoad();
            } else {
                img.onload = handleImageLoad;
            }
        });
    });
</script>
{% endif %}

<div class="card detail-section">
    <div class="card-content">
        <div class="header-actions" style="margin-bottom: 1rem;">
            <h2 class="detail-header" style="margin-bottom: 0;">Garotas nesta edição</h2>
            <a href="{% url 'issue_appearance_create' issue.pk %}" class="btn-circle-add open-modal"
                style="width: 32px; height: 32px; font-size: 20px;">+</a>
        </div>

        {% if sections_data %}
        <table>
            <thead>
                <tr>
                    <th style="width: 20%;">Seção</th>
                    <th style="width: 60%;">Mulheres</th>
                    <th style="width: 20%;">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for group in sections_data %}
                <tr>
                    <!-- Seção Column -->
                    <td>
                        <span class="section-badge">
                            {{ group.section.name }}
                        </span>
                    </td>

                    <!-- Mulheres Column -->
                    <td>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                            {% for appearance in group.appearances %}
                            <div class="woman-pill"
                                style="display: inline-flex; align-items: center; background-color: #f3f4f6; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem;">
                                <a href="{% url 'woman_detail' appearance.woman.pk %}"
                                    style="color: #374151; text-decoration: none; margin-right: 0.5rem;">
                                    {{ appearance.woman.name }}
                                </a>
                                <a href="{% url 'appearance_delete' appearance.pk %}?next={% url 'issue_detail' issue.pk %}"
                                    class="open-modal"
                                    style="color: #ef4444; cursor: pointer; display: flex; align-items: center;"
                                    title="Remove {{ appearance.woman.name }} from this section">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </a>
                            </div>
                            {% endfor %}

                            <!-- Add Woman to Section Button -->
                            <a href="{% url 'issue_appearance_create' issue.pk %}?section_id={{ group.section.pk }}"
                                class="btn-circle-add-small open-modal"
                                style="width: 24px; height: 24px; font-size: 16px; background-color: #e5e7eb; color: #4b5563; display: flex; align-items: center; justify-content: center; border-radius: 50%; text-decoration: none;"
                                title="Add Woman to {{ group.section.name }}">
                                +
                            </a>
                        </div>
                    </td>

                    <!-- Ações Column -->
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <a href="{% url 'issue_section_update' issue.pk group.section.pk %}"
                                class="btn-icon-edit open-modal" title="Edit Section Group">
                                {% include 'core/includes/icon_edit.html' %}
                            </a>
                            <a href="{% url 'issue_section_delete' issue.pk group.section.pk %}"
                                class="btn-icon-delete open-modal" title="Delete Section Group">
                                {% include 'core/includes/icon_trash.html' %}
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-state">Nenhuma garota encontrada nesta edição.</p>
        {% endif %}
    </div>
</div>
{% endblock %}