{% extends 'core/base.html' %}
{% load i18n %}

{% block content %}
<div class="header-actions">
    <div class="breadcrumb">
        <a href="{% url 'home' %}">Home</a> / {% trans "Issues" %}
    </div>
    <a href="{% url 'issue_create' %}" class="btn-circle-add open-modal" title="{% trans 'New Issue' %}">+</a>
</div>

<h1>{% trans "Issues" %}</h1>

<div class="grid-cards">
    {% for issue in issues %}
    <a href="{% url 'issue_detail' issue.pk %}" class="card">
        <div class="card-cover">
            {% with covers=issue.covers.all %}
            {% if covers %}
            {% for cover in covers %}
            <img src="{{ cover.image.url }}" id="cover-{{ issue.pk }}-{{ forloop.counter0 }}"
                class="cover-image {% if forloop.first %}active{% endif %}" alt="Cover {{ forloop.counter }}">
            {% endfor %}

            {% if covers|length > 1 %}
            <div class="cover-nav">
                {% for cover in covers %}
                <button type="button" class="nav-dot {% if forloop.first %}active{% endif %}"
                    data-index="{{ forloop.counter0 }}"
                    onclick="switchCover(event, {{ issue.pk }}, {{ forloop.counter0 }})"></button>
                {% endfor %}
            </div>
            {% endif %}
            {% else %}
            <div
                style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #9ca3af;">
                {% trans "No Cover" %}
            </div>
            {% endif %}
            {% endwith %}
        </div>
        <div class="card-content">
            <h3>{{ issue }}</h3>
            <p class="cta-text">
                {% trans "View details" %} &rarr;
            </p>
        </div>
    </a>
    {% empty %}
    <p class="empty-state">{% trans "No issues found." %}</p>
    {% endfor %}
</div>

<script>
    function switchCover(event, issueId, index) {
        event.preventDefault();
        event.stopPropagation();

        const card = event.target.closest('.card');

        // Hide all active images
        const images = card.querySelectorAll('.cover-image');
        images.forEach(img => img.classList.remove('active'));

        // Show target image
        const targetImg = card.querySelector(`#cover-${issueId}-${index}`);
        if (targetImg) targetImg.classList.add('active');

        // Update dots
        const dots = card.querySelectorAll('.nav-dot');
        dots.forEach(dot => dot.classList.remove('active'));

        // Activate target dot
        const targetDot = card.querySelector(`.nav-dot[data-index="${index}"]`);
        if (targetDot) targetDot.classList.add('active');
    }

    document.addEventListener("DOMContentLoaded", function () {
        const coverImages = document.querySelectorAll('.cover-image');

        coverImages.forEach(img => {
            function handleImageLoad() {
                // Check if it's a double cover (Landscape orientation)
                // Using a threshold of 1.2 aspect ratio to be safe
                const aspect = img.naturalWidth / img.naturalHeight;

                if (aspect > 1.2) {
                    // It's a double cover.
                    // Since it's object-fit: cover, centering chops off the sides.
                    // We want to show the RIGHT side (front cover) usually, but user said "left side" in previous turn.
                    // WAIT. Re-reading user request: 
                    // "Em geral capas dobráveis têm como parte primária o lado esquerdo da imagem"
                    // So user wants LEFT side.
                    // Default object-position is 50% 50%.
                    // We need '0% 50%' (left).
                    img.style.objectPosition = 'left';
                }
            }

            if (img.complete) {
                handleImageLoad();
            } else {
                img.onload = handleImageLoad;
            }
        });
    });
</script>

{% if years %}
<div class="pagination-container"
    style="display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-top: 2rem;">

    <div class="pagination-controls" style="display: flex; align-items: center; gap: 0.5rem;">
        <!-- First Year -->
        {% if current_year != first_year %}
        <a href="?year={{ first_year }}" class="btn" title="{% trans 'First Year' %} ({{ first_year }})">
            &laquo; {% trans "First" %}
        </a>
        {% else %}
        <span class="btn disabled">&laquo; {% trans "First" %}</span>
        {% endif %}

        <!-- Previous Year -->
        {% if previous_year %}
        <a href="?year={{ previous_year }}" class="btn" title="{% trans 'Previous Year' %} ({{ previous_year }})">
            &lsaquo; {% trans "Prev" %}
        </a>
        {% else %}
        <span class="btn disabled">&lsaquo; {% trans "Prev" %}</span>
        {% endif %}

        <!-- Current Year Display -->
        <span class="current-year" style="font-weight: bold; font-size: 1.2rem; padding: 0 1rem;">
            {{ current_year }}
        </span>

        <!-- Next Year -->
        {% if next_year %}
        <a href="?year={{ next_year }}" class="btn" title="{% trans 'Next Year' %} ({{ next_year }})">
            {% trans "Next" %} &rsaquo;
        </a>
        {% else %}
        <span class="btn disabled">{% trans "Next" %} &rsaquo;</span>
        {% endif %}

        <!-- Last Year -->
        {% if current_year != last_year %}
        <a href="?year={{ last_year }}" class="btn" title="{% trans 'Last Year' %} ({{ last_year }})">
            {% trans "Last" %} &raquo;
        </a>
        {% else %}
        <span class="btn disabled">{% trans "Last" %} &raquo;</span>
        {% endif %}
    </div>

    <!-- Go to specific year form -->
    <form action="" method="get" class="goto-year-form" style="display: flex; align-items: center; gap: 0.5rem;">
        <label for="year-input">{% trans "Go to year:" %}</label>
        <input type="number" id="year-input" name="year" min="{{ first_year }}" max="{{ last_year }}"
            value="{{ current_year }}" class="form-control" style="width: 80px; text-align: center;">
        <button type="submit" class="btn btn-sm">{% trans "Go" %}</button>
    </form>

</div>
{% endif %}
{% endblock %}